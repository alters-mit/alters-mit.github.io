<!DOCTYPE html>
<script src="js/jquery.min.js"></script>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>alters-mit</title>
</head>
<body>
<script>
    // Source: https://stackoverflow.com/a/46215202
    function copy(text) {
    let input = document.createElement('input');
    input.setAttribute('value', text);
    document.body.appendChild(input);
    input.select();
    let result = document.execCommand('copy');
    document.body.removeChild(input);
    return result;
 }

    $('head').append('<link rel="stylesheet" type="text/css" href="css/purple.css">');
    const repos = ["threedworld-mit/tdw", "alters-mit/magnebot", "alters-mit/tdw_physics", "alters-mit/transport_challenge", "alters-mit/multimodal_challenge"];
    const unity_urls = ["https://github.com/threedworld-mit/tdw_visualizers", "https://github.com/alters-mit/robot_creator"];
    const pypi_icon = '<img src="images/pypi.png" alt="pypi">';
    const github_icon = '<img src="images/github.png" alt="pypi">';

    let repo_names = [];
    for (i = 0; i < repos.length; i++) {
        repo_names[i] = /\/(.*)/.exec(repos[i])[1];
    }
    const pypi = ["tdw", "magnebot", null, null, null];
    const descriptions = ["ThreeDWorld simulation environment",
        "High-level API for the TDW Magnebot",
        "Generic structures to create TDW physics datasets",
        "Extension of the Magnebot API for the Transport Challenge",
        "Multi-modal challenge for the Magnebot API"];

    // The spacer string for install scripts.
    let spacer = " ???? ";
    if (navigator.appVersion.indexOf("Mac") != -1 || navigator.appVersion.indexOf("Linux") != -1)
    {
        spacer = " && ";
    }
    else if (navigator.appVersion.indexOf("Win") != -1)
    {
        spacer = " ; ";
    }

    // Get the name of the repo and the latest release.
    repos.forEach(function(repo, i) {
        let main_branch = "main";
        if (repo_names[i] === "tdw" || repo_names[i] === "tdw_physics"){
            main_branch = "master";
        }
        // Get the TDW-related requirements.
        let setup_url = "https://raw.githubusercontent.com/" + repo + "/" + main_branch + "/setup.py";
        let version = "";
        let latest_release_url = "https://github.com/" + repo + "/releases/latest";
        if (repo_names[i] === "tdw"){
            setup_url = "https://raw.githubusercontent.com/threedworld-mit/tdw/master/Python/setup.py";
        }
        // Get install and update instructions.
        let install = "<h4><img src='images/desktop-download-16.svg' alt='install'> Install:</h4>\n\n<ul>\n";
        let update = "<h4><img src='images/repo-pull-16.svg' alt='update'> Update:</h4>\n\n<ul>\n";
        let git_pull = "cd " + repo_names[i] + spacer + "git pull";
        let git_clone = github_icon + " <code>git clone " + "https://github.com/" + repo + ".git";
        // Install script to install.
        let install_script = "git clone https://github.com/" + repo + ".git" + spacer;
        if (repo === "threedworld-mit/tdw")
        {
            install_script += "cd tdw/Python"
        }
        else{
            install_script += "cd " + repo_names[i];
        }
        install_script += spacer + "pip3 install -e .";

        let clone_repo = "";
        if (repo === "threedworld-mit/tdw"){
            clone_repo = git_clone + spacer + "cd " + repo_names[i] + "/Python" + spacer + "pip3 install -e .</code>";
        }
        else{
            clone_repo = git_clone + spacer + "cd " + repo_names[i] + spacer  + "pip3 install -e .</code>";
        }
        if (pypi[i] != null){
            let pip_install = "pip3 install " + pypi[i];
            let pip_update = "pip3 install " + pypi[i] + " -U";
            install += "<li><b>Users:</b> " + pypi_icon + " <code>" + pip_install + "</code> ";
            install += '<button type="button" onClick="copy(' + "'"  + pip_install + "')" + '">Copy</button></li>\n';
            install += "<li><b>Developers:</b> " + clone_repo + " ";
            install += '<button type="button" onClick="copy(' + "'"  + install_script + "')" + '">Copy</button></li>\n';

            update += "<li><b>Users:</b> " + pypi_icon + " <code>" + pip_update + "</code> ";
            update += '<button type="button" onClick="copy(' + "'"  + pip_update + "')" + '">Copy</button></li>\n';
            update +="<li><b>Developers: </b>" + github_icon + " <code>" + git_pull + "</code> ";
            update += '<button type="button" onClick="copy(' + "'"  + git_pull + "')" + '">Copy</button></li>\n';
        }
        else{
            install +="<li><b>Everyone: </b>" + clone_repo + " ";
            install += '<button type="button" onClick="copy(' + "'"  + install_script + "')" + '">Copy</button></li>\n';
            update +="<li><b>Everyone: </b>" + github_icon + " <code>" + git_pull + "</code> ";
            update += '<button type="button" onClick="copy(' + "'"  + git_pull + "')" + '">Copy</button></li>\n';
        }
        $.ajax({
            async: false,
            type: 'GET',
            url: setup_url,
            datatype: 'text',
            success: function(resp){
                if (repo_names[i] === "tdw"){
                    version = /__version__ = "(.*)"/.exec(resp)[1];
                }
                else{
                    version = /version="(.*)"/.exec(resp)[1];
                }
                let install_requires_raw = /install_requires=\[((.|\n)*)\]/sgm.exec(resp)[1].split(',');
                let install_requires = [];
                for (j = 0; j < install_requires_raw.length; j++){
                    install_requires_raw[j] = install_requires_raw[j].replace(/'/g, '');
                    if (install_requires_raw[j].includes("==")){
                        for (k = 0; k < repo_names.length; k++){
                            if (install_requires_raw[j].includes(repo_names[k])){
                                install_requires.push(install_requires_raw[j]);
                            }
                        }
                    }
                }
                if (install_requires.length > 0){
                    install += "\n\n<p><b>Requires:</b> " + install_requires.join(" and ") + "</p>\n";
                }
            }
        });
        install += "</ul>\n\n";
        update += "</ul>\n\n";
        let repo_div = '<div id="' + repo_names[i] + '">\n';
        repo_div += '<h2><a href="https://github.com/' + repo + '">' + repo_names[i] + "</a></h2>\n\n<p>" + descriptions[i] + "</p>\n\n";
        repo_div += '<h4>Latest: <a href="' + latest_release_url + '">' + version + '</a></h4>';
        repo_div += install + update;

        let repo_url = "https://api.github.com/repos/" + repo;
        // Get issues and pull requests.
        $.ajax({
            async: false,
            type: 'GET',
            url: repo_url + "/issues",
            data:{
              state: "open"
            },
            success: function(resp){
                let issues = "<h4><img src=\"images/issue-opened-16.svg\" alt='issues'> Issues:</h4>";
                let pulls = "<h4><img src=\"images/git-pull-request-16.svg\" alt='pull requests'> Pull Requests:</h4>";
                issues += "<ul>";
                pulls += "<ul>";
                $.each(resp, function (i, issue) {
                    let issue_html = ('<li><a href="' + issue.html_url + '">' + issue.number + ": " + issue.title + '</a></li>');
                    if (!issue.hasOwnProperty("pull_request")){
                        issues += issue_html;
                    }
                    else{
                        pulls += issue_html;
                    }
                });
                issues += "</ul>";
                pulls += "</ul>";
                repo_div += issues;
                repo_div += pulls;
            }
        });

        repo_div += "</div>\n\n";
        $("body").append(repo_div);
    });

    // Append Unity repos.
    const unit_descriptions = ["Display images of TDW models and visual materials", "Create robot asset bundles for TDW"];
    unity_urls.forEach(function(unity_url, i) {
        // Source: https://stackoverflow.com/a/16848676
        let unity_name = /(\/)(?!.*\/)(.*)/.exec(unity_url)[2];
        let unity_div = '<div id="' + unity_name + '">\n';
        unity_div += '<h2><a href="' + unity_url + '">' + unity_name + "</a></h2>\n\n<p>" + unit_descriptions[i] + "</p>\n\n";
        unity_div += "</div>\n\n";
        $("body").append(unity_div);
    });

    // Build the sidebar.
    let sidebar = '<div class="sidenav" id="toc">\n';
    repo_names.forEach(function(repo) {
        sidebar += '<a href="#' + repo + '">' + repo + '</a>\n';
    });
    unity_urls.forEach(function(url){
        let repo = /(\/)(?!.*\/)(.*)/.exec(url)[2];
        sidebar += '<a href="#' + repo + '">' + repo + '</a>\n';
    });
    sidebar += "</div>";
    $("body").append(sidebar);
</script>
</body>
</html>