<!DOCTYPE html>
<script src="js/jquery.min.js"></script>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<script>
    $('head').append('<link rel="stylesheet" type="text/css" href="css/purple.css">');
    const root_url = "https://api.github.com/repos/";
    const repos = ["threedworld-mit/tdw", "alters-mit/magnebot", "alters-mit/tdw_physics", "alters-mit/transport_challenge", "alters-mit/multimodal_challenge"];
    let repo_names = [];
    for (i = 0; i < repos.length; i++) {
        repo_names[i] = /\/(.*)/.exec(repos[i])[1];
    }
    const pypi = ["tdw", "magnebot", null, null, null];

    let sidebar = '<div class="sidenav" style="width:100%;right:0" id="toc">\n';
    repo_names.forEach(function(repo) {
        sidebar += '<a href="#' + repo + '">' + repo + '</a>\n';
    });
    sidebar += "</div>";
    $("body").append(sidebar);

    // Get the name of the repo and the latest release.
    repos.forEach(function(repo, i) {
        let repo_url = root_url + repo;
        let main_branch = "main";
        if (repo_names[i] === "tdw" || repo_names[i] === "tdw_physics"){
            main_branch = "master";
        }

        let repo_div = '<div id="' + repo_names[i] + '">\n';
        // Get the description and latest release.
        $.ajax({
           async: false,
           type: 'GET',
           url: repo_url,
            success: function(resp){
               repo_div += "<h2><a href=\"" + resp.url + "\">" + resp.name + "</a></h2>\n\n<p>" + resp.description + "</p>\n\n";
            }
        });
        $.ajax({
            async: false,
            type: 'GET',
            url: repo_url + "/tags",
            success: function(resp){
                repo_div += "<h4>Latest: <a href=\"https://github.com/" + repo + "/releases/tag/" + resp[0].name + "\">" + resp[0].name + "</h4></a>";
            }
        });

        // Get install and update instructions.
        let install = "<h4><img src='images/desktop-download-16.svg' alt='install'> Install:</h4>\n\n<ul>\n";
        let update = "<h4><img src='images/repo-pull-16.svg' alt='update'> Update:</h4>\n\n<ul>\n";
        let git_pull = "<code>cd path/to/" + repo_names[i] + "</code> and <code>git pull</code>";
        let clone_repo = "";
        if (repo === "threedworld-mit/tdw"){
            clone_repo = "Clone the repo, <code>cd path/to/" + repo_names[i] + "/Python</code> and <code>pip3 install -e .</code>";
        }
        else{
            clone_repo = "Clone the repo, <code>cd path/to/" + repo_names[i] + "</code> and <code>pip3 install -e .</code>";
        }
        if (pypi[i] != null){
            install += "<li><b>Users: </b><code>pip3 install " + pypi[i] + "</code></li>\n";
            install += "<li><b>Developers:</b> " + clone_repo + "</li>\n";
            update += "<li><b>Users: </b><code>pip3 install " + pypi[i] + " -U</code></li>\n";
            update += "<li><b>Developers:</b> " + git_pull + "</li>\n";
        }
        else{
            install +="<li><b>Everyone: </b>" + clone_repo + "</li>\n";
            update +="<li><b>Everyone: </b>" + git_pull + "</li>\n";
        }

        // Get the TDW-related requirements.
        let setup_url = "https://raw.githubusercontent.com/" + repo + "/" + main_branch + "/setup.py";
        if (repo_names[i] === "tdw"){
            setup_url = "https://raw.githubusercontent.com/threedworld-mit/tdw/master/Python/setup.py";
        }
        $.ajax({
            async: false,
            type: 'GET',
            url: setup_url,
            datatype: 'text',
            success: function(resp){
                let install_requires = /install_requires=\[((.|\n)*)\]/sgm.exec(resp)[1].split(',');
                for (j = 0; j < install_requires.length; j++){
                    install_requires[j] = install_requires[j].replace(/'/g, '');
                    if (install_requires[j].includes("==")){
                        for (k = 0; k < repo_names.length; k++){
                        if (install_requires[j].includes(repo_names[k])){
                            install += "<ul><li>Requires: " + install_requires[j] + "</li></ul>\n";
                        }
                    }
                    }
                }
            }
        });
        install += "</ul>\n\n";
        update += "</ul>\n\n";
        repo_div += install + update;

        // Get issues and pull requests.
        $.ajax({
            async: false,
            type: 'GET',
            url: repo_url + "/issues",
            data:{
              state: "open"
            },
            success: function(resp){
                let issues = "<h4><img src=\"images/issue-opened-16.svg\" alt='issues'> Issues:</h4>";
                issues += "<ul>";
                $.each(resp, function (i, issue) {
                    if (!issue.hasOwnProperty("pull_request")){
                        issues += ('<li><a href="' + issue.html_url + '">' + issue.number + ": " + issue.title + '</a></li>');
                    }
                });
                issues += "</ul>";
                repo_div += issues;
            }
        });
        $.ajax({
            async: false,
            type: 'GET',
            url: repo_url + "/pulls",
            data:{
              state: "open"
            },
            success: function(resp){
                let issues = "<h4><img src=\"images/git-pull-request-16.svg\" alt='pull requests'> Pull Requests:</h4>";
                issues += "<ul>";
                $.each(resp, function (i, issue) {
                    issues += ('<li><a href="' + issue.html_url + '">' + issue.number + ": " + issue.title + '</a></li>');
                });
                issues += "</ul>";
                repo_div += issues;
            }
        });
        repo_div += "</div>\n\n";
        $("body").append(repo_div);
    });
</script>
</body>
</html>